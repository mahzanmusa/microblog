EC2 OS - Amazon Linux 2023

'''
$ sudo yum -y install python3.13 python3-devel postfix nginx git python3-pip

####### Not needed
#######$ pip3 install supervisor

$ git clone https://github.com/mahzanmusa/microblog.git

$ cd microblog

# Create .env file
SECRET_KEY=<your-secret-key-for-forms>
MAIL_SERVER=localhost
MAIL_PORT=8025
DATABASE_URL=mysql+pymysql://<db-username>:<db-password>@<db-url>:3306/<db-name>
MS_TRANSLATOR_KEY=<ms-azure-translator-key>
MS_TRANSLATOR_REGION=<ms-azure-region>
AWS_ACCESS_KEY_ID=<aws-access-key-id>
AWS_SECRET_ACCESS_KEY=<aws-secret-access-key>
AWS_DEFAULT_REGION=<aws-region>

$ python3.13 -m venv venv
$ source venv/bin/activate
(venv) $ pip install -r requirements.txt
(venv) $ pip install gunicorn pymysql cryptography

####### Not needed
####### (venv) $ gunicorn -b localhost:8000 -w 4 microblog:app

# Create database
(venv) $ flask db upgrade

'''

'''
# Check nginx status:
$ sudo systemctl status nginx

# Check if locally running:
$ curl -I http://localhost:8000

#update nginx config file. Comment out existing port 80/443 listening
$ sudo nano /etc/nginx/nginx.conf


server {
    listen       80;
    listen       [::]:80;
    
    # COMMENT OUT or REMOVE the 'root' line if you want to be safe
    # root         /usr/share/nginx/html;

    # Load configuration files for the default server block.
    include /etc/nginx/default.d/*.conf;

    location / {
        # THIS IS THE IMPORTANT PART
        proxy_pass http://127.0.0.1:8000; # Ensure this matches your Gunicorn port
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
}

# test and reload nginx
$ sudo nginx -t
$ sudo systemctl reload nginx
'''

'''
# Set systemd service file so apps runs automatically in the background
$ sudo nano /etc/systemd/system/microblog.service

[Unit]
Description=Gunicorn instance to serve my Flask app
After=network.target

[Service]
# The user you log in as (usually 'ec2-user' on Amazon Linux, or 'ubuntu')
User=ec2-user               
Group=nginx

# The output from the 'pwd' command you ran earlier
WorkingDirectory=/home/ec2-user/microblog

# The specific path to the gunicorn executable you found with 'which gunicorn'
# IMPORTANT: Ensure the bind address (127.0.0.1:8000) matches your Nginx config!
ExecStart=/home/ec2-user/microblog/venv/bin/gunicorn --workers 3 --bind 127.0.0.1:8000 microblog:app

Restart=always

[Install]
WantedBy=multi-user.target


$ sudo systemctl daemon-reload
$ sudo systemctl start microblog
$ sudo systemctl enable microblog
# Verify it's running
$ sudo systemctl status microblog
'''